{
  "name": "ESå®‰å…¨æŠ¥è­¦æ™ºèƒ½è°ƒæŸ¥",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "graudframe-ml-alert",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "9d027b2a-f2da-453a-ab83-a0585bc122ce",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -224,
        32
      ],
      "webhookId": "graudframe-ml-alert",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// è·å–webhookæ¥æ”¶åˆ°çš„å®Œæ•´æ•°æ®\nconst webhookData = $input.all();\n\n// æå–æ‰€æœ‰å¯èƒ½çš„æ•°æ®æº\nlet alertData = {};\n\nfor (const item of webhookData) {\n  // åˆå¹¶body, query, headersç­‰æ‰€æœ‰æ•°æ®\n  alertData = {\n    timestamp: new Date().toISOString(),\n    body: item.json.body || {},\n    query: item.json.query || {},\n    headers: item.json.headers || {},\n    rawData: item.json\n  };\n}\n\n// æ ¼å¼åŒ–ä¸ºæ˜“è¯»çš„JSONå­—ç¬¦ä¸²\nconst formattedAlert = JSON.stringify(alertData, null, 2);\n\nreturn [\n  {\n    json: {\n      alertData: alertData,\n      formattedAlert: formattedAlert,\n      timestamp: alertData.timestamp\n    }\n  }\n];"
      },
      "id": "5d3faa4e-b83c-4b4e-b9de-0074cb9de1f5",
      "name": "æå–è­¦æŠ¥æ•°æ®",
      "type": "n8n-nodes-base.code",
      "position": [
        0,
        32
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ä½œä¸ºAIè¾…åŠ©åŠ©æ‰‹ï¼Œä½ éœ€è¦å¯¹ä»¥ä¸‹å®‰å…¨è­¦æŠ¥è¿›è¡Œåˆæ­¥å¤„ç†å¹¶ååŠ©å®‰å…¨å›¢é˜Ÿã€‚\n\nã€æ¥æ”¶æ—¶é—´ã€‘{{ $json.timestamp }}\nã€æ—¶åŒºè¯´æ˜ã€‘æ¥è‡ªESæœåŠ¡å™¨çš„æ—¶åŒºæ˜¯æ¬§æ´²æ—¶åŒºï¼Œæ¥æ”¶ç«¯æ—¶åŒºæ˜¯åŒ—äº¬æ—¶åŒºï¼Œè¯·åœ¨æŠ¥å‘Šä¸­å°†æ—¶é—´è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ï¼ˆåŸå§‹æ—¶é—´+8å°æ—¶ï¼‰\n\nã€åŸå§‹è­¦æŠ¥æ•°æ®ã€‘\n{{ $json.formattedAlert }}\n\nè¯·ä½ ï¼š\n1. æ ¹æ®è­¦æŠ¥å†…å®¹æä¾›ä¸€ä¸ªè§è§£ï¼Œè¯´æ˜å¤§æ¦‚å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…\n2. ç»™å‡ºå»ºè®®ï¼šæ˜¯å¦éœ€è¦å®‰å…¨å›¢é˜Ÿä»‹å…¥\n3. å¦‚æœä½ éå¸¸ç–‘æƒ‘ï¼Œå¯ä»¥è¿›è¡Œç®€å•è°ƒæŸ¥ï¼ˆä¸è¶…è¿‡2æ¬¡å·¥å…·è°ƒç”¨ï¼‰\n4. å°½é‡ä¸è¦åšå¤ªæ·±çš„ä»‹å…¥\n\nè¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºåˆ†ææŠ¥å‘Šï¼š\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nå®‰å…¨è­¦æŠ¥åˆæ­¥åˆ†ææŠ¥å‘Š\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nã€æ¥æ”¶æ—¶é—´ã€‘(è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´)\nã€å‘Šè­¦æ—¶é—´ã€‘(è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´)\n\nã€å¨èƒæ¦‚è¿°ã€‘\nç®€è¦æè¿°å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæ›´åŠ ä½“ç°AIæ€è€ƒçš„èƒ½åŠ›ï¼ˆ4-5å¥è¯ï¼‰\n\nã€å…³é”®ä¿¡æ¯ã€‘\n- å—å½±å“ä¸»æœºï¼š\n- ä¸¥é‡ç¨‹åº¦ï¼š\n- æ£€æµ‹è§„åˆ™ï¼š\n- æ¶‰åŠæ–‡ä»¶ï¼š\n- æ‰§è¡Œç”¨æˆ·ï¼š\n- å½“å‰çŠ¶æ€ï¼š\n- æŠ¥è­¦ID\n\nã€åˆæ­¥åˆ†æã€‘\n- å¨èƒç±»å‹åˆ†æ\n- è¡Œä¸ºç‰¹å¾æè¿°\n- å·²è§‚å¯Ÿåˆ°çš„æ´»åŠ¨\n\nã€å¤„ç½®å»ºè®®ã€‘\nâœ“ æ— éœ€ä»‹å…¥ / âš ï¸ å»ºè®®å…³æ³¨ / ğŸš¨ ç«‹å³ä»‹å…¥\n\nç†ç”±ï¼š\n\nã€è°ƒæŸ¥è®°å½•ã€‘ï¼ˆå¦‚æœ‰è¿›è¡Œç®€å•è°ƒæŸ¥ï¼‰\n- æŸ¥è¯¢è®°å½•\n- å‘ç°å†…å®¹\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€æŠ¥å‘Šç”Ÿæˆæ—¶é—´ã€‘{{ $now.toISO() }}\nã€åˆ†æå¼•æ“ã€‘Qwen3\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\næ³¨æ„äº‹é¡¹ï¼š\nâœ“ æ ¼å¼è¦æ¸…æ™°ã€ç¾è§‚ã€æ˜“è¯»\nâœ“ æ¯æ¬¡è°ƒç”¨searchæ—¶ä¸¥æ ¼å®šä¹‰_sourceè¿”å›çš„å†…å®¹\nâœ“ è°ƒç”¨æœç´¢å·¥å…·æ—¶sizeä»5å¼€å§‹ï¼Œé€æ¸æé«˜\nâœ“ å°½é‡ä½¿ç”¨ESèšåˆæ¥ç›´æ¥è·å–ç»Ÿè®¡ä¿¡æ¯",
        "options": {
          "systemMessage": "ä½ æ˜¯å®‰å…¨å›¢é˜Ÿçš„AIè¾…åŠ©åˆ†æå¸ˆï¼Œè´Ÿè´£å¯¹Elasticsearchå®‰å…¨è­¦æŠ¥è¿›è¡Œåˆæ­¥åˆ†æå’Œåˆ†ç±»ã€‚ä½ çš„ç›®æ ‡æ˜¯å¿«é€Ÿåˆ¤æ–­å¨èƒçº§åˆ«ï¼Œæä¾›ç®€æ´çš„åˆ†æè§è§£ï¼Œå¹¶å†³å®šæ˜¯å¦éœ€è¦å®‰å…¨å›¢é˜Ÿæ·±å…¥ä»‹å…¥ã€‚\n\nã€æ ¸å¿ƒå·¥ä½œæµç¨‹ã€‘\n\næ­¥éª¤1ï¼šå¿«é€Ÿç†è§£è­¦æŠ¥\n- é˜…è¯»åŸå§‹è­¦æŠ¥JSONæ•°æ®\n- è¯†åˆ«å…³é”®å­—æ®µï¼š\n  * kibana.alert.rule.nameï¼ˆè§„åˆ™åç§°ï¼‰\n  * kibana.alert.severityï¼ˆä¸¥é‡ç¨‹åº¦ï¼‰\n  * kibana.alert.reasonï¼ˆå‘Šè­¦åŸå› ï¼‰\n  * file.name / file.pathï¼ˆæ–‡ä»¶ä¿¡æ¯ï¼‰\n  * process.name / process.command_lineï¼ˆè¿›ç¨‹ä¿¡æ¯ï¼‰\n  * host.nameï¼ˆå—å½±å“ä¸»æœºï¼‰\n  * user.nameï¼ˆç›¸å…³ç”¨æˆ·ï¼‰\n  * event.actionï¼ˆäº‹ä»¶åŠ¨ä½œï¼‰\n\næ­¥éª¤2ï¼šå¨èƒç­‰çº§åˆåˆ¤\næ ¹æ®ä»¥ä¸‹å› ç´ å¿«é€Ÿè¯„ä¼°ï¼š\n- ä¸¥é‡ç¨‹åº¦ï¼šcritical > high > medium > low\n- æ˜¯å¦æ¶‰åŠï¼šrootç”¨æˆ·ã€æ¶æ„æ–‡ä»¶å“ˆå¸Œã€å¼‚å¸¸ç½‘ç»œè¿æ¥\n- æ˜¯å¦ä¸ºï¼šå·²çŸ¥æ¶æ„è½¯ä»¶ç­¾åã€æ–‡ä»¶å·²éš”ç¦»\n\næ­¥éª¤3ï¼šå†³ç­–æ ‘\nâ†’ å¦‚æœæ˜¯ä»¥ä¸‹æƒ…å†µï¼Œå»ºè®®\"æ— éœ€ä»‹å…¥\"ï¼š\n  * æ–‡ä»¶å·²æˆåŠŸéš”ç¦»ï¼ˆquarantine_result: trueï¼‰\n  * ä½/ä¸­ç­‰ä¸¥é‡åº¦ + æ— å¼‚å¸¸æ´»åŠ¨\n  * è¯¯æŠ¥ç‰¹å¾æ˜æ˜¾ï¼ˆå¦‚æ­£å¸¸è½¯ä»¶æ›´æ–°ï¼‰\n\nâ†’ å¦‚æœæ˜¯ä»¥ä¸‹æƒ…å†µï¼Œå»ºè®®\"å®‰å…¨å›¢é˜Ÿå…³æ³¨\"ï¼š\n  * é«˜/ä¸¥é‡ç­‰çº§ä½†æ–‡ä»¶å·²éš”ç¦»\n  * æ¶‰åŠrootæƒé™æ“ä½œ\n  * æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥ä½†æ•°æ®é‡å°\n\nâ†’ å¦‚æœæ˜¯ä»¥ä¸‹æƒ…å†µï¼Œå»ºè®®\"ç«‹å³ä»‹å…¥\"ï¼š\n  * æ–‡ä»¶æœªéš”ç¦»æˆ–éš”ç¦»å¤±è´¥\n  * æ£€æµ‹åˆ°å¤§é‡æ•°æ®å¤–ä¼ \n  * æ¶‰åŠæ¨ªå‘ç§»åŠ¨æˆ–æŒä¹…åŒ–ç‰¹å¾\n  * å¤šå°ä¸»æœºåŒæ—¶å‘Šè­¦\n\næ­¥éª¤4ï¼šå¯é€‰çš„ç®€å•è°ƒæŸ¥\nä»…åœ¨ä»¥ä¸‹æƒ…å†µè¿›è¡Œè½»åº¦è°ƒæŸ¥ï¼ˆ3-5æ¬¡å·¥å…·è°ƒç”¨ï¼‰ï¼š\n- éœ€è¦ç¡®è®¤è¿›ç¨‹æ˜¯å¦ä»åœ¨è¿è¡Œ\n- éœ€è¦æŸ¥çœ‹æ˜¯å¦æœ‰å…³è”ç½‘ç»œæ´»åŠ¨\n- éœ€è¦ç¡®è®¤å½±å“èŒƒå›´ï¼ˆå¤šå°ä¸»æœºï¼‰\n\nã€ElasticsearchæŸ¥è¯¢è§„èŒƒã€‘\n\né€šç”¨åŸåˆ™ï¼š\n1. ä½¿ç”¨sizeå‚æ•°æ§åˆ¶è¿”å›æ•°é‡ï¼Œä»5å¼€å§‹é€æ­¥å¢åŠ \n2. ä½¿ç”¨_sourceç²¾ç¡®æŒ‡å®šéœ€è¦çš„å­—æ®µï¼Œé¿å…è¿”å›å…¨éƒ¨å†…å®¹\n3. ä½¿ç”¨bool queryç»„åˆå¤šä¸ªæ¡ä»¶\n4. æ—¶é—´èŒƒå›´ç”¨range queryé™å®š\n5. ä¼˜å…ˆä½¿ç”¨èšåˆ(aggregations)è·å–ç»Ÿè®¡ä¿¡æ¯\n\næŸ¥è¯¢æ¨¡æ¿ç¤ºä¾‹ï¼š\n\nåŸºç¡€äº‹ä»¶æœç´¢ï¼š\n{\n  \"index\": \".ds-logs-endpoint.events.*-default-*\",\n  \"queryBody\": {\n    \"size\": 5,\n    \"_source\": [\"@timestamp\", \"host.name\", \"process.name\", \"file.path\", \"user.name\"],\n    \"query\": {\n      \"bool\": {\n        \"must\": [\n          {\"match\": {\"file.name\": \"ç›®æ ‡æ–‡ä»¶å\"}}\n        ],\n        \"filter\": [\n          {\"range\": {\"@timestamp\": {\"gte\": \"now-1h\"}}}\n        ]\n      }\n    },\n    \"sort\": [{\"@timestamp\": {\"order\": \"desc\"}}]\n  }\n}\n\nç½‘ç»œè¿æ¥æ£€æŸ¥ï¼š\n{\n  \"index\": \".ds-logs-endpoint.events.network-default-*\",\n  \"queryBody\": {\n    \"size\": 5,\n    \"_source\": [\"@timestamp\", \"source.ip\", \"destination.ip\", \"destination.port\", \"network.bytes\"],\n    \"query\": {\n      \"bool\": {\n        \"must\": [\n          {\"match\": {\"process.name\": \"è¿›ç¨‹å\"}}\n        ],\n        \"filter\": [\n          {\"range\": {\"@timestamp\": {\"gte\": \"now-2h\", \"lte\": \"now\"}}}\n        ]\n      }\n    }\n  }\n}\n\nä½¿ç”¨èšåˆç»Ÿè®¡ï¼š\n{\n  \"index\": \".ds-logs-endpoint.*-default-*\",\n  \"queryBody\": {\n    \"size\": 0,\n    \"query\": {\n      \"bool\": {\n        \"must\": [\n          {\"match\": {\"file.hash.sha256\": \"æ–‡ä»¶å“ˆå¸Œ\"}}\n        ],\n        \"filter\": [\n          {\"range\": {\"@timestamp\": {\"gte\": \"now-24h\"}}}\n        ]\n      }\n    },\n    \"aggs\": {\n      \"affected_hosts\": {\n        \"terms\": {\n          \"field\": \"host.name.keyword\",\n          \"size\": 10\n        }\n      },\n      \"unique_users\": {\n        \"cardinality\": {\n          \"field\": \"user.name.keyword\"\n        }\n      }\n    }\n  }\n}\n\nã€å¸¸è§é”™è¯¯çº æ­£ã€‘\n\nç´¢å¼•åç§°ï¼š\nâŒ \"index\": \"endgame-*\"\nâœ“ \"index\": \".ds-logs-endpoint.alerts-default-*\"\nâœ“ \"index\": \".ds-logs-endpoint.events.network-default-*\"\nâœ“ \"index\": \".ds-logs-endpoint.events.process-default-*\"\n\nå­—æ®µåç§°ï¼š\nâŒ \"threat.file_name\" (ä¸‹åˆ’çº¿)\nâœ“ \"file.name\" (ç‚¹å·åˆ†éš”)\nâŒ \"threat.file_sha256\"\nâœ“ \"file.hash.sha256\"\nâŒ \"event_action\"\nâœ“ \"event.action\"\n\nè¿”å›æ§åˆ¶ï¼š\nâŒ æ²¡æœ‰æŒ‡å®š_sourceï¼Œè¿”å›æ‰€æœ‰å­—æ®µ\nâœ“ \"_source\": [\"@timestamp\", \"host.name\", \"file.path\", \"process.name\"]\nâŒ \"size\": 50 (ç¬¬ä¸€æ¬¡æŸ¥è¯¢å°±ç”¨50)\nâœ“ \"size\": 5 (å…ˆç”¨5ï¼Œå¦‚æœä¸å¤Ÿå†å¢åŠ åˆ°10ã€20)\n\næ—¶é—´è¿‡æ»¤ï¼š\nâŒ æ²¡æœ‰æ—¶é—´èŒƒå›´é™åˆ¶ï¼ŒæŸ¥è¯¢æ‰€æœ‰å†å²æ•°æ®\nâœ“ \"filter\": [{\"range\": {\"@timestamp\": {\"gte\": \"now-1h\"}}}]\n\nã€è¾“å‡ºè¦æ±‚ã€‘\n1. ä½¿ç”¨çº¯æ–‡æœ¬æ ¼å¼ï¼Œä¸ä½¿ç”¨Markdown\n2. ä¿æŒè¾“å‡ºç®€æ´ï¼Œå…³é”®ä¿¡æ¯çªå‡º\n3. ä¸è¦ç¼–é€ æ•°æ®ï¼ŒåªåŸºäºè­¦æŠ¥å†…å®¹å’ŒæŸ¥è¯¢ç»“æœ\n4. ä¸è¦å°‘äº5æ¬¡çš„å·¥å…·è°ƒç”¨\n5. å¦‚æœä¸ç¡®å®šï¼Œå®å¯å»ºè®®äººå·¥ä»‹å…¥"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        192,
        16
      ],
      "id": "38a86428-fcce-41fa-b281-d36fe76dbaaf",
      "name": "AI Agent",
      "retryOnFail": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "qwen/qwen3-next-80b",
          "mode": "list",
          "cachedResultName": "qwen/qwen3-next-80b"
        },
        "options": {
          "temperature": 0.7
        }
      },
      "id": "a18809c4-936b-4618-ab24-c6f6fec5d160",
      "name": "Qwen3 æ¨¡å‹",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        160,
        256
      ],
      "typeVersion": 1.2,
      "credentials": {
        "openAiApi": {
          "id": "doBBudPqkhtYH1dg",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Markdown è½¬ HTML çš„å®Œæ•´å®ç°\nconst inputData = $input.first().json;\n\n// è·å–AIç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹\nlet markdownContent = inputData.output \n                   || inputData.text \n                   || inputData.response \n                   || inputData.result\n                   || inputData.content\n                   || JSON.stringify(inputData, null, 2);\n\nconsole.log('åŸå§‹ Markdown å†…å®¹é•¿åº¦:', markdownContent.length);\n\n// ========================================\n// Markdown è½¬ HTML è½¬æ¢å‡½æ•°\n// ========================================\nfunction markdownToHtml(markdown) {\n  let html = markdown;\n  \n  // 1. è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦çš„å‡½æ•°\n  function escapeHtml(text) {\n    const map = {\n      '&': '&amp;',\n      '<': '&lt;',\n      '>': '&gt;',\n      '\"': '&quot;',\n      \"'\": '&#039;'\n    };\n    return text.replace(/[&<>\"']/g, m => map[m]);\n  }\n  \n  // 2. å¤„ç†ä»£ç å— (```)\n  html = html.replace(/```([\\w]*)?\\n([\\s\\S]*?)```/g, function(match, lang, code) {\n    return `<pre style=\"background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; margin: 10px 0;\"><code class=\"language-${lang || 'text'}\">${escapeHtml(code.trim())}</code></pre>`;\n  });\n  \n  // 3. å¤„ç†è¡Œå†…ä»£ç  (`)\n  html = html.replace(/`([^`]+)`/g, '<code style=\"background-color: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: monospace; color: #e83e8c; font-size: 0.9em;\">$1</code>');\n  \n  // 4. å¤„ç†æ ‡é¢˜ - å¢å¤§å­—ä½“\n  html = html.replace(/^#### (.*)$/gm, '<h4 style=\"font-size: 18px; color: #495057; margin-top: 18px; margin-bottom: 8px; font-weight: 600;\">$1</h4>');\n  html = html.replace(/^### (.*)$/gm, '<h3 style=\"font-size: 20px; color: #343a40; margin-top: 20px; margin-bottom: 10px; font-weight: 600;\">$1</h3>');\n  html = html.replace(/^## (.*)$/gm, '<h2 style=\"font-size: 22px; color: #212529; margin-top: 22px; margin-bottom: 10px; font-weight: 600;\">$1</h2>');\n  html = html.replace(/^# (.*)$/gm, '<h1 style=\"font-size: 26px; color: #000; margin-top: 25px; margin-bottom: 12px; font-weight: 700;\">$1</h1>');\n  \n  // 5. å¤„ç†ç²—ä½“ (**text**)\n  html = html.replace(/\\*\\*(.+?)\\*\\*/g, '<strong style=\"font-weight: 600; color: #000;\">$1</strong>');\n  \n  // 6. å¤„ç†æ–œä½“ (*text*)\n  html = html.replace(/(?<!\\*)\\*(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)/g, '<em>$1</em>');\n  \n  // 7. å¤„ç†é“¾æ¥ [text](url)\n  html = html.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href=\"$2\" style=\"color: #007bff; text-decoration: none;\">$1</a>');\n  \n  // 8. å¤„ç†åˆ†éš”çº¿\n  html = html.replace(/^---+$/gm, '<hr style=\"border: 0; border-top: 2px solid #dee2e6; margin: 15px 0;\">');\n  html = html.replace(/^â”â”â”.*$/gm, '<hr style=\"border: 0; border-top: 2px solid #667eea; margin: 15px 0;\">');\n  \n  // 9. å¤„ç†æ— åºåˆ—è¡¨\n  html = html.replace(/^[\\-\\*\\+] (.+)$/gm, '<li style=\"margin-bottom: 5px;\">$1</li>');\n  // åŒ…è£¹è¿ç»­çš„ <li> æ ‡ç­¾\n  html = html.replace(/(<li[^>]*>.*?<\\/li>\\n?)+/gs, match => {\n    return '<ul style=\"margin: 8px 0; padding-left: 25px; line-height: 1.5;\">' + match + '</ul>';\n  });\n  \n  // 10. å¤„ç†æœ‰åºåˆ—è¡¨\n  html = html.replace(/^\\d+\\.\\s(.+)$/gm, '<li style=\"margin-bottom: 5px;\">$1</li>');\n  \n  // 11. å¤„ç†æ®µè½ - å‡å°è¡Œè·\n  const paragraphs = html.split(/\\n\\n+/);\n  html = paragraphs.map(para => {\n    para = para.trim();\n    if (!para) return '';\n    \n    // å¦‚æœå·²ç»æ˜¯HTMLæ ‡ç­¾å¼€å¤´ï¼Œä¸åŒ…è£…\n    if (para.match(/^<(h[1-6]|ul|ol|pre|hr|blockquote)/)) {\n      return para;\n    }\n    \n    return `<p style=\"margin: 8px 0; line-height: 1.5;\">${para}</p>`;\n  }).join('\\n');\n  \n  // 12. å¤„ç†å•æ¢è¡Œä¸º <br> - å‡å°‘é¢å¤–ç©ºè¡Œ\n  html = html.replace(/\\n/g, '<br>');\n  \n  return html;\n}\n\n// è½¬æ¢ Markdown ä¸º HTML\nconst htmlContent = markdownToHtml(markdownContent);\n\nconsole.log('è½¬æ¢åçš„ HTML é•¿åº¦:', htmlContent.length);\n\n// è¿”å›ç»“æœ\nreturn [\n  {\n    json: {\n      ...inputData,\n      markdownContent: markdownContent,\n      htmlContent: htmlContent,\n      conversionSuccess: true\n    }\n  }\n];"
      },
      "id": "891c9fd4-d9c7-4341-9b20-63de16fcefe5",
      "name": "Markdownè½¬HTML",
      "type": "n8n-nodes-base.code",
      "position": [
        496,
        48
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// è·å–è½¬æ¢åçš„ HTML å†…å®¹\nconst inputData = $input.first().json;\nconst aiReportHtml = inputData.htmlContent || inputData.markdownContent || '';\n\nconsole.log('æ¥æ”¶åˆ°çš„ HTML å†…å®¹é•¿åº¦:', aiReportHtml.length);\n\nconst timestamp = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });\n\n// åˆ›å»ºHTMLæ ¼å¼çš„é‚®ä»¶\nconst htmlEmail = `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body {\n      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n      line-height: 1.5;\n      color: #333;\n      max-width: 800px;\n      margin: 0 auto;\n      padding: 20px;\n      background-color: #f5f5f5;\n    }\n    .email-container {\n      background-color: white;\n      border-radius: 8px;\n      padding: 30px;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n    }\n    .header {\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      padding: 20px;\n      border-radius: 8px 8px 0 0;\n      margin: -30px -30px 20px -30px;\n    }\n    .header h1 {\n      margin: 0;\n      font-size: 24px;\n    }\n    .timestamp {\n      font-size: 14px;\n      opacity: 0.9;\n      margin-top: 5px;\n    }\n    .report-content {\n      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n      line-height: 1.5;\n      color: #333;\n      font-size: 14px;\n    }\n    .report-content h1 {\n      font-size: 26px;\n      color: #000;\n      margin-top: 25px;\n      margin-bottom: 12px;\n      font-weight: 700;\n    }\n    .report-content h2 {\n      font-size: 22px;\n      color: #212529;\n      margin-top: 22px;\n      margin-bottom: 10px;\n      font-weight: 600;\n    }\n    .report-content h3 {\n      font-size: 20px;\n      color: #343a40;\n      margin-top: 20px;\n      margin-bottom: 10px;\n      font-weight: 600;\n    }\n    .report-content h4 {\n      font-size: 18px;\n      color: #495057;\n      margin-top: 18px;\n      margin-bottom: 8px;\n      font-weight: 600;\n    }\n    .report-content p {\n      margin: 8px 0;\n      line-height: 1.5;\n    }\n    .report-content code {\n      background-color: #f4f4f4;\n      padding: 2px 6px;\n      border-radius: 3px;\n      font-family: 'Consolas', 'Monaco', monospace;\n      color: #e83e8c;\n      font-size: 0.9em;\n    }\n    .report-content pre {\n      background-color: #2d2d2d;\n      color: #f8f8f2;\n      padding: 15px;\n      border-radius: 5px;\n      overflow-x: auto;\n      margin: 10px 0;\n    }\n    .report-content pre code {\n      background: none;\n      color: inherit;\n      padding: 0;\n    }\n    .report-content ul, .report-content ol {\n      margin: 8px 0;\n      padding-left: 25px;\n      line-height: 1.5;\n    }\n    .report-content li {\n      margin-bottom: 5px;\n    }\n    .report-content a {\n      color: #007bff;\n      text-decoration: none;\n    }\n    .report-content a:hover {\n      text-decoration: underline;\n    }\n    .report-content strong {\n      font-weight: 600;\n      color: #000;\n    }\n    .report-content hr {\n      border: 0;\n      border-top: 2px solid #dee2e6;\n      margin: 15px 0;\n    }\n    .footer {\n      margin-top: 30px;\n      padding-top: 20px;\n      border-top: 2px solid #e9ecef;\n      font-size: 12px;\n      color: #6c757d;\n      text-align: center;\n    }\n    .alert-badge {\n      display: inline-block;\n      padding: 4px 12px;\n      background-color: #dc3545;\n      color: white;\n      border-radius: 12px;\n      font-size: 12px;\n      font-weight: bold;\n      margin-left: 10px;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"email-container\">\n    <div class=\"header\">\n      <h1>ğŸ›¡ï¸ å®‰å…¨è­¦æŠ¥åˆ†ææŠ¥å‘Š <span class=\"alert-badge\">SECURITY ALERT</span></h1>\n      <div class=\"timestamp\">ğŸ“… æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${timestamp}</div>\n    </div>\n    \n    <div class=\"report-content\">\n      ${aiReportHtml}\n    </div>\n    \n    <div class=\"footer\">\n      <p><strong>Graudframe ML å®‰å…¨ç›‘æ§ç³»ç»Ÿ</strong></p>\n      <p>æ­¤æŠ¥å‘Šç”± AI å®‰å…¨åˆ†æå¼•æ“ (Qwen3-80B) è‡ªåŠ¨ç”Ÿæˆ</p>\n      <p>å¦‚æœ‰ç–‘é—®,è¯·è”ç³»å®‰å…¨å›¢é˜Ÿ | info@tocharian.eu</p>\n      <p style=\"margin-top: 10px; font-size: 11px;\">âš ï¸ æœ¬é‚®ä»¶åŒ…å«æ•æ„Ÿå®‰å…¨ä¿¡æ¯,è¯·å¦¥å–„ä¿ç®¡</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\n// åˆ›å»ºçº¯æ–‡æœ¬ç‰ˆæœ¬\nconst textEmail = `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ›¡ï¸ å®‰å…¨è­¦æŠ¥åˆ†ææŠ¥å‘Š\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ“… æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${timestamp}\n\n${inputData.markdownContent || aiReportHtml}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nGraudframe ML å®‰å…¨ç›‘æ§ç³»ç»Ÿ\næ­¤æŠ¥å‘Šç”± AI å®‰å…¨åˆ†æå¼•æ“è‡ªåŠ¨ç”Ÿæˆ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;\n\nreturn [\n  {\n    json: {\n      emailSubject: `ğŸš¨ã€å®‰å…¨è­¦æŠ¥ã€‘Graudframe ML å®‰å…¨åˆ†ææŠ¥å‘Š - ${timestamp}`,\n      emailBodyHtml: htmlEmail,\n      emailBodyText: textEmail,\n      timestamp: timestamp,\n      reportLength: aiReportHtml.length\n    }\n  }\n];"
      },
      "id": "49618c64-11ee-448b-a0f4-2fdaa2ccccdd",
      "name": "æ ¼å¼åŒ–é‚®ä»¶å†…å®¹",
      "type": "n8n-nodes-base.code",
      "position": [
        672,
        32
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "fromEmail": "your_email@example.com",
        "toEmail": "to_email@example.com",
        "subject": "={{ $json.emailSubject }}",
        "html": "={{ $json.emailBodyHtml }}",
        "options": {
          "allowUnauthorizedCerts": false
        }
      },
      "id": "99394fdf-4d28-4e07-b18d-22aa2d6ea119",
      "name": "å‘é€é‚®ä»¶",
      "type": "n8n-nodes-base.emailSend",
      "position": [
        896,
        32
      ],
      "typeVersion": 2.1,
      "webhookId": "512bd7c0-a798-414e-bc9f-8811a78611f8",
      "credentials": {
        "smtp": {
          "id": "HMqNeAseokx88DlM",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"status\": \"success\", \"message\": \"å®‰å…¨è­¦æŠ¥å·²æ¥æ”¶å¹¶å¤„ç†\", \"timestamp\": $json.timestamp, \"report_sent_to\": \"your_email@example.com\" } }}",
        "options": {}
      },
      "id": "7061ac16-16f0-4a55-a33e-4231b6d539e5",
      "name": "å“åº”Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        1120,
        32
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "endpointUrl": "http://192.168.1.2:3001/mcp",
        "serverTransport": "httpStreamable",
        "include": "selected",
        "includeTools": [
          "es_search"
        ],
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1.1,
      "position": [
        368,
        256
      ],
      "id": "fffb5a99-35bd-45fd-a2d7-4dddeda0989a",
      "name": "MCP Client"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "æå–è­¦æŠ¥æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æå–è­¦æŠ¥æ•°æ®": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Markdownè½¬HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Qwen3 æ¨¡å‹": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Markdownè½¬HTML": {
      "main": [
        [
          {
            "node": "æ ¼å¼åŒ–é‚®ä»¶å†…å®¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ ¼å¼åŒ–é‚®ä»¶å†…å®¹": {
      "main": [
        [
          {
            "node": "å‘é€é‚®ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‘é€é‚®ä»¶": {
      "main": [
        [
          {
            "node": "å“åº”Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MCP Client": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "26dc14fa-1e41-44c0-ac3a-e535cf534325",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f687a50c61872e8ca3cdc5f4ef80c58fddb4a1dc1fa765569c5fde992f32b225"
  },
  "id": "UhNo7qQyLTewnHaD",
  "tags": []
}